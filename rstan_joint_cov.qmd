---
title: "rstan_joint_model_cov"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(haven)
library(MatchIt)
library(optmatch)
library(lavaan)
library(semTools)
library(rstan)
library(shinystan)
library(survival)
library(coda)
library(rjags)
library(pROC)
library(ggplot2)
library(flextable)
```
# Importing and Cleaning 




```{r}
H_HRS_d <- read_sav("/path/to/your/data/H_HRS_d.sav")


randhrs1992_2020v2 <- read_sav("/path/to/your/data/randhrs1992_2020v2.sav") %>% 
  # Combining the two different forms of cognitive testing 
  mutate(r14imrc = ifelse(!is.na(R14IMRCP), R14IMRCP, R14IMRCW)) %>% 
  mutate(r15imrc = ifelse(!is.na(R15IMRCP), R15IMRCP, R15IMRCW)) %>% 
  
  mutate(r14dlrc = ifelse(!is.na(R14DLRCP), R14DLRCP, R14DLRCW)) %>% 
  mutate(r15dlrc = ifelse(!is.na(R15DLRCP), R15DLRCP, R15DLRCW)) %>% 
  
  mutate(r14ser7 = ifelse(!is.na(R14SER7P), R14SER7P, R14SER7W)) %>% 
  mutate(r15ser7 = ifelse(!is.na(R15SER7P), R15SER7P, R15SER7W)) %>% 
  
  mutate(r14bwc20 = ifelse(!is.na(R14BWC20P), R14BWC20P, R14BWC20W)) %>% 
  mutate(r15bwc20 = ifelse(!is.na(R15BWC20P), R15BWC20P, R15BWC20W)) 


rand <- randhrs1992_2020v2 %>% 
  dplyr::select(
    HHIDPN,
    RAGENDER,
    contains("ser7"),
    contains("imrc"),
    contains("dlrc"),
    contains("bwc20"),
    contains("mo"),
    contains("dy"),
    contains("yr"),
    contains("agey_e"),
    contains("cesd"),
    contains("raracem"),
    contains("hibp"),
    contains("diab"),
    contains("cancr"),
    contains("lung"),
    contains("heart"),
    contains("strok"),
    contains("arthr")
  ) %>% 
  dplyr::select(
    !starts_with("s")
  ) %>% 
  dplyr::select(
    !contains("FSER")
  ) %>% 
  dplyr::select(
    !contains("FIMRC")
  ) %>% 
  dplyr::select(
    !contains("FDLRC")
  ) 

#remove(randhrs1992_2020v1)

colnames(rand) <- tolower(colnames(rand))

# Only individuals with interviews from wave 6 to 15
hrs_email <- H_HRS_d %>% 
  subset(r6iwmode != 0 &
           r7iwmode != 0 &
           r8iwmode != 0 &
           r9iwmode != 0 &
           r10iwmode != 0 &
           r11iwmode != 0 &
           r12iwmode != 0 &
           r13iwmode != 0 &
           r14iwmode != 0 &
           r15iwmode != 0)

rand_hrs <- inner_join(rand, hrs_email, by = "hhidpn")

```

# Email Use

## Filtering and variable selection
```{r}
# Filter by age if needed
rand_hrs_age <- rand_hrs 
#%>% 
 # filter(r6agey_e >= 65)

rand_hrs_email <- rand_hrs_age %>% 
  filter(!is.na(r6email))

rand_hrs_email <- rand_hrs_email %>% 
  dplyr::select(
    hhidpn,
    ragender,
    raeducl,
    raracem,
    contains("rural"),
    starts_with("r6"),
    starts_with("r7"),
    starts_with("r8"),
    starts_with("r9"),
    starts_with("r10"),
    starts_with("r11"),
    starts_with("r12"),
    starts_with("r13"),
    starts_with("r14"),
    starts_with("r15")
    ) %>% 
  dplyr::select(
    hhidpn,
    ragender,
    raeducl,
    contains("agey_e"),
    contains("socwk"),
    contains("mo"),
    contains("dy"),
    contains("yr"),
    contains("age_y"),
    contains("rural"),
    contains("sight"),
    contains("urinai"),
    contains("rested"),
    contains("iadltot_h"),
    contains("adltot6"),
    contains("mobilsev"),
    contains("email"),
    contains("lowermob"),
    contains("angin"),
    contains("conhrtf"),
    contains("arthlmt"),
    contains("jointr"),
    contains("hrtsrg"),
    contains("bmicat"),
    contains("painlv"),
    contains("hearing"),
    contains("mstat"),
    contains("orient"),
    contains("ser7"),
    contains("imrc"),
    contains("dlrc"),
    contains("cesd"),
    contains("hibp"),
    contains("diab"),
    contains("cancr"),
    contains("lung"),
    contains("heart"),
    contains("strok"),
    contains("arthr"),
    contains("raracem"),
    contains("bwc20")
  )
  

rand_hrs_email <- rand_hrs_email %>% 
  dplyr::select(!contains("smok")) %>% 
  dplyr::select(!contains("mammo")) %>% 
  dplyr::select(!contains("mom")) %>% 
  dplyr::select(!contains("cmode")) %>% 
  dplyr::select(!contains("money")) %>% 
  dplyr::select(!contains("promot")) %>% 
  dplyr::select(!contains("mov")) %>% 
  dplyr::select(!contains("mon")) %>% 
  dplyr::select(!contains("fmo")) %>%
  dplyr::select(!contains("fdy")) %>%
  dplyr::select(!contains("fyr")) %>% 
  dplyr::select(!contains("mobm")) %>%
  dplyr::select(!contains("moba")) %>%
  dplyr::select(!contains("sevm")) %>%
  dplyr::select(!contains("seva")) %>%
  dplyr::select(!contains("forient")) %>% 
  dplyr::select(!contains("hlp")) %>% 
  dplyr::select(!contains("wendy")) %>% 
  dplyr::select(!contains("jpd")) %>% 
  dplyr::select(!contains("ret")) %>% 
  dplyr::select(!contains("cmp")) %>% 
  dplyr::select(!contains("pln")) %>% 
  dplyr::select(!contains("mcr"))

gc()
```

```{r}
# Create TICS variables
rand_hrs_email <- rand_hrs_email %>% 
  mutate(r6tics = r6imrc + r6dlrc + r6ser7 + r6bwc20) %>% 
  mutate(r7tics = r7imrc + r7dlrc + r7ser7 + r7bwc20) %>% 
  mutate(r8tics = r8imrc + r8dlrc + r8ser7 + r8bwc20) %>% 
  mutate(r9tics = r9imrc + r9dlrc + r9ser7 + r9bwc20) %>% 
  mutate(r10tics = r10imrc + r10dlrc + r10ser7 + r10bwc20) %>% 
  mutate(r11tics = r11imrc + r11dlrc + r11ser7 + r11bwc20) %>% 
  mutate(r12tics = r12imrc + r12dlrc + r12ser7 + r12bwc20) %>% 
  mutate(r13tics = r13imrc + r13dlrc + r13ser7 + r13bwc20) %>%
  mutate(r14tics = r14imrc + r14dlrc + r14ser7 + r14bwc20) %>%
  mutate(r15tics = r15imrc + r15dlrc + r15ser7 + r15bwc20) 


# Account for reverse causality by removing those with MCI up to wave 9
rand_hrs_email2 <- rand_hrs_email %>% 
  filter(!r6tics < 12) %>% 
  filter(!r7tics < 12) %>% 
  filter(!r8tics < 12) %>% 
  filter(!r9tics < 12)
```


```{r}
# na_sum <- colSums(is.na(rand_hrs_email))
# print(na_sum)
# 
# rand_hrs_email <- rand_hrs_email %>% 
#   filter(!is.na(raeducl)) %>% 
#   filter(!is.na(raracem))
```


## Create a proxy for chronic disease burden

```{r}
rand_hrs_email <- rand_hrs_email %>% 
  mutate(r6chron_disease = as.numeric(r6hibp + r6diab + r6cancr + r6lung + r6heart + r6strok + r6arthr)) %>%
  mutate(r7chron_disease = as.numeric(r7hibp + r7diab + r7cancr + r7lung + r7heart + r7strok + r7arthr)) %>%
  mutate(r8chron_disease = as.numeric(r8hibp + r8diab + r8cancr + r8lung + r8heart + r8strok + r8arthr)) %>%
  mutate(r9chron_disease = as.numeric(r9hibp + r9diab + r9cancr + r9lung + r9heart + r9strok + r9arthr)) %>% 
  mutate(r10chron_disease = as.numeric(r10hibp + r10diab + r10cancr + r10lung + r10heart + r10strok + r10arthr)) %>% 
  mutate(r11chron_disease = as.numeric(r11hibp + r11diab + r11cancr + r11lung + r11heart + r11strok + r11arthr)) %>% 
  mutate(r12chron_disease = as.numeric(r12hibp + r12diab + r12cancr + r12lung + r12heart + r12strok + r12arthr)) %>% 
  mutate(r13chron_disease = as.numeric(r13hibp + r13diab + r13cancr + r13lung + r13heart + r13strok + r13arthr)) %>%
  mutate(r14chron_disease = as.numeric(r14hibp + r14diab + r14cancr + r14lung + r14heart + r14strok + r14arthr)) %>% 
  mutate(r15chron_disease = as.numeric(r15hibp + r15diab + r15cancr + r15lung + r15heart + r15strok + r15arthr))

rand_hrs_data <- rand_hrs_email

rand_trial <- rand_hrs_email %>% 
  filter(!is.na(r6chron_disease)) 

mean(rand_trial$r6chron_disease)
sd(rand_trial$r6chron_disease)
```



## Scale variables to have mean 0 and sd 1
```{r}
rand_hrs_data$r6agey_e <- as.numeric(scale(rand_hrs_data$r6agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r7agey_e <- as.numeric(scale(rand_hrs_data$r7agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r8agey_e <- as.numeric(scale(rand_hrs_data$r8agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r9agey_e <- as.numeric(scale(rand_hrs_data$r9agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r10agey_e <- as.numeric(scale(rand_hrs_data$r10agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r11agey_e <- as.numeric(scale(rand_hrs_data$r11agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r12agey_e <- as.numeric(scale(rand_hrs_data$r12agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r13agey_e <- as.numeric(scale(rand_hrs_data$r13agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r14agey_e <- as.numeric(scale(rand_hrs_data$r14agey_e, center = TRUE, scale = TRUE))
rand_hrs_data$r15agey_e <- as.numeric(scale(rand_hrs_data$r15agey_e, center = TRUE, scale = TRUE))


rand_hrs_data$r6cesd <- as.numeric(scale(rand_hrs_data$r6cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r7cesd <- as.numeric(scale(rand_hrs_data$r7cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r8cesd <- as.numeric(scale(rand_hrs_data$r8cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r9cesd <- as.numeric(scale(rand_hrs_data$r9cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r10cesd <- as.numeric(scale(rand_hrs_data$r10cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r11cesd <- as.numeric(scale(rand_hrs_data$r11cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r12cesd <- as.numeric(scale(rand_hrs_data$r12cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r13cesd <- as.numeric(scale(rand_hrs_data$r13cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r14cesd <- as.numeric(scale(rand_hrs_data$r14cesd, center = TRUE, scale = TRUE))
rand_hrs_data$r15cesd <- as.numeric(scale(rand_hrs_data$r15cesd, center = TRUE, scale = TRUE))

#rand_hrs_data$raeducl <- scale(rand_hrs_data$raeducl, center = TRUE, scale = TRUE)

#rand_hrs_data$ragender <- scale(rand_hrs_data$ragender, center = TRUE, scale = TRUE)
#rand_hrs_data$raracem<- scale(rand_hrs_data$raracem, center = TRUE, scale = TRUE)

rand_hrs_data$raracem <- as.factor(rand_hrs_data$raracem)
rand_hrs_data$raeducl <- as.factor(rand_hrs_data$raeducl)

raeducl_levels <- model.matrix(~ raeducl - 1, 
                               data = rand_hrs_data)

rand_hrs_data <- cbind(rand_hrs_data, raeducl_levels)


raracem_levels <- model.matrix(~ raracem - 1, 
                               data = rand_hrs_data
                               )

rand_hrs_data <- cbind(rand_hrs_data, raracem_levels)
rand_hrs_data$h9rural <- as.numeric(scale(rand_hrs_data$h9rural, center = TRUE, scale = TRUE))
rand_hrs_data$h10rural <- as.numeric(scale(rand_hrs_data$h10rural, center = TRUE, scale = TRUE))
rand_hrs_data$h11rural <- as.numeric(scale(rand_hrs_data$h11rural, center = TRUE, scale = TRUE))
rand_hrs_data$h12rural <- as.numeric(scale(rand_hrs_data$h12rural, center = TRUE, scale = TRUE))
rand_hrs_data$h13rural <- as.numeric(scale(rand_hrs_data$h13rural, center = TRUE, scale = TRUE))


rand_hrs_data$r6chron_disease <- as.numeric(scale(rand_hrs_data$r6chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r7chron_disease <- as.numeric(scale(rand_hrs_data$r7chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r8chron_disease <- as.numeric(scale(rand_hrs_data$r8chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r9chron_disease <- as.numeric(scale(rand_hrs_data$r9chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r10chron_disease <- as.numeric(scale(rand_hrs_data$r10chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r11chron_disease <- as.numeric(scale(rand_hrs_data$r11chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r12chron_disease <- as.numeric(scale(rand_hrs_data$r12chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r13chron_disease <- as.numeric(scale(rand_hrs_data$r13chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r14chron_disease <- as.numeric(scale(rand_hrs_data$r14chron_disease, center = TRUE, scale = TRUE))
rand_hrs_data$r15chron_disease <- as.numeric(scale(rand_hrs_data$r15chron_disease, center = TRUE, scale = TRUE))


rand_hrs_data$r6adltot6 <- as.numeric(scale(rand_hrs_data$r6adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r7adltot6 <- as.numeric(scale(rand_hrs_data$r7adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r8adltot6 <- as.numeric(scale(rand_hrs_data$r8adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r9adltot6 <- as.numeric(scale(rand_hrs_data$r9adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r10adltot6 <- as.numeric(scale(rand_hrs_data$r10adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r11adltot6 <- as.numeric(scale(rand_hrs_data$r11adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r12adltot6 <- as.numeric(scale(rand_hrs_data$r12adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r13adltot6 <- as.numeric(scale(rand_hrs_data$r13adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r14adltot6 <- as.numeric(scale(rand_hrs_data$r14adltot6, center = TRUE, scale = TRUE))
rand_hrs_data$r15adltot6 <- as.numeric(scale(rand_hrs_data$r15adltot6, center = TRUE, scale = TRUE))


rand_hrs_data$r6iadltot_h <- as.numeric(scale(rand_hrs_data$r6iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r7iadltot_h <- as.numeric(scale(rand_hrs_data$r7iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r8iadltot_h <- as.numeric(scale(rand_hrs_data$r8iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r9iadltot_h <- as.numeric(scale(rand_hrs_data$r9iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r10iadltot_h <- as.numeric(scale(rand_hrs_data$r10iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r11iadltot_h <- as.numeric(scale(rand_hrs_data$r11iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r12iadltot_h <- as.numeric(scale(rand_hrs_data$r12iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r13iadltot_h <- as.numeric(scale(rand_hrs_data$r13iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r14iadltot_h <- as.numeric(scale(rand_hrs_data$r14iadltot_h, center = TRUE, scale = TRUE))
rand_hrs_data$r15iadltot_h <- as.numeric(scale(rand_hrs_data$r15iadltot_h, center = TRUE, scale = TRUE))


```

```{r}

selected_columns <- c("ragender",
                                      "raeducl",
                                      "r6email",
                                      "r7email",
                                      "r8email",
                                      "r9email",
                                      "r10email",
                                      "r11email",
                                      "r12email",
                                      "r13email",
                                      "r14email",
                                      "r15email",

                                      "r6cesd",
                                      "r7cesd",
                                      "r8cesd",
                                      "r9cesd",
                                      "r10cesd",
                                      "r11cesd",
                                      "r12cesd",
                                      "r13cesd",
                                      "r14cesd",
                                      "r15cesd",

                                      "r6chron_disease",
                                      "r7chron_disease",
                                      "r8chron_disease",
                                      "r9chron_disease",
                                      "r10chron_disease",
                                      "r11chron_disease",
                                      "r12chron_disease",
                                      "r13chron_disease",
                                      "r14chron_disease",
                                      "r15chron_disease",

                                      "r6iadltot_h",
                                      "r7iadltot_h",
                                      "r8iadltot_h",
                                      "r9iadltot_h",
                                      "r10iadltot_h",
                                      "r11iadltot_h",
                                      "r12iadltot_h",
                                      "r13iadltot_h",
                                      "r14iadltot_h",
                                      "r15iadltot_h",

                                      "r6adltot6",
                                      "r7adltot6",
                                      "r8adltot6",
                                      "r9adltot6",
                                      "r10adltot6",
                                      "r11adltot6",
                                      "r12adltot6",
                                      "r13adltot6",
                                      "r14adltot6",
                                      "r15adltot6",

                                      "r6agey_e",
                                      "r7agey_e",
                                      "r8agey_e",
                                      "r9agey_e",
                                      "r10agey_e",
                                      "r11agey_e",
                                      "r12agey_e",
                                      "r13agey_e",
                                      "r14agey_e",
                                      "r15agey_e",

                                      "r6imrc",
                                      "r7imrc",
                                      "r8imrc",
                                      "r9imrc",
                                      "r10imrc",
                                      "r11imrc",
                                      "r12imrc",
                                      "r13imrc",
                                      "r14imrc",
                                      "r15imrc",

                                      "r6dlrc",
                                      "r7dlrc",
                                      "r8dlrc",
                                      "r9dlrc",
                                      "r10dlrc",
                                      "r11dlrc",
                                      "r12dlrc",
                                      "r13dlrc",
                                      "r14dlrc",
                                      "r15dlrc",

                                      "r6ser7",
                                      "r7ser7",
                                      "r8ser7",
                                      "r9ser7",
                                      "r10ser7",
                                      "r11ser7",
                                      "r12ser7",
                                      "r13ser7",
                                      "r14ser7",
                                      "r15ser7",

                                      "r6bwc20",
                                      "r7bwc20",
                                      "r8bwc20",
                                      "r9bwc20",
                                      "r10bwc20",
                                      "r11bwc20",
                                      "r12bwc20",
                                      "r13bwc20",
                                      "r14bwc20",
                                      "r15bwc20",

                                      "r6tics",
                                      "r7tics",
                                      "r8tics",
                                      "r9tics",
                                      "r10tics",
                                      "r11tics",
                                      "r12tics",
                                      "r13tics",
                                      "r14tics",
                                      "r15tics"
                                     )

#
```

```{r}
# Calculate percentage of NA values for each column
na_percentage <- rand_hrs_data %>%
  summarise(across(all_of(selected_columns), 
                   ~ sum(is.na(.)) / n() * 100, 
                   .names = "{col}"))
na_percentage <- (round(na_percentage, 2))



ft <- na_percentage %>%   
  t() %>%
  as.data.frame() %>% 
  rownames_to_column() %>%
  setNames(c("Variable", "Proportion of Missing Data")) %>%
  as.data.frame() %>% 
  flextable() %>%
  set_caption("Table 1: Proportion of Missing Data per Variable") %>% 
  theme_vanilla() %>% 
  autofit() %>%
  add_header_lines("Note: Each value represents the proportion of missing data within each variable. Figures have already been converted to percentages.")

# Save as an HTML file
save_as_html(ft, path = "na_percentage.html")



```


```{r}
#some additional data cleaning and imputing NA values with median 

rand_hrs_data$ragender <- 2 - rand_hrs_data$ragender   #re-code as 0 and 1 (0 indicates female; 1 indicates male)
rand_hrs_data$raracem1_r <- 1 - rand_hrs_data$raracem1  #re-code as 0 and 1 (0 means whites or nh-whites? 1 means other)
rand_hrs_data$r6chron_disease[is.na(rand_hrs_data$r6chron_disease)] <- median(rand_hrs_data$r6chron_disease, na.rm = T)
rand_hrs_data$r7chron_disease[is.na(rand_hrs_data$r7chron_disease)] <- median(rand_hrs_data$r7chron_disease, na.rm = T)
rand_hrs_data$r8chron_disease[is.na(rand_hrs_data$r8chron_disease)] <- median(rand_hrs_data$r8chron_disease, na.rm = T)
rand_hrs_data$r9chron_disease[is.na(rand_hrs_data$r9chron_disease)] <- median(rand_hrs_data$r9chron_disease, na.rm = T)
rand_hrs_data$r10chron_disease[is.na(rand_hrs_data$r10chron_disease)] <- median(rand_hrs_data$r10chron_disease, na.rm = T)
rand_hrs_data$r11chron_disease[is.na(rand_hrs_data$r11chron_disease)] <- median(rand_hrs_data$r11chron_disease, na.rm = T)
rand_hrs_data$r12chron_disease[is.na(rand_hrs_data$r12chron_disease)] <- median(rand_hrs_data$r12chron_disease, na.rm = T)
rand_hrs_data$r13chron_disease[is.na(rand_hrs_data$r13chron_disease)] <- median(rand_hrs_data$r13chron_disease, na.rm = T)
rand_hrs_data$r14chron_disease[is.na(rand_hrs_data$r14chron_disease)] <- median(rand_hrs_data$r14chron_disease, na.rm = T)
rand_hrs_data$r15chron_disease[is.na(rand_hrs_data$r15chron_disease)] <- median(rand_hrs_data$r15chron_disease, na.rm = T)

table(rand_hrs_data$ragender)
table(rand_hrs_data$raracem1_r)
summary(rand_hrs_data$r9chron_disease)

ordered_vars <- c("r6email", "r7email", "r8email", "r9email", "r10email", "r11email", "r12email", "r13email", "r14email", "r15email")
# parallel_fit_email <- sem(parallel_model_email, data = rand_hrs_data, ordered = ordered_vars)
# 
# summary(parallel_fit_email)
# 
# # Extract fit measures
# fitMeasures(parallel_fit_email, c("chisq", "df", "pvalue", "cfi", "tli", "rmsea", "rmsea.ci.lower", "rmsea.ci.upper", "srmr"))
```

### With Covariates

```{r}
#----------------------------
#Joint latent growth-survival model

rand_hrs_jags <- rand_hrs_data

#rand_hrs_jags <- rand_hrs_jags.copy

# data preparation creating event time and event status
rand_hrs_jags <- rand_hrs_jags %>%
  mutate(
    event_time = case_when(
      is.na(r7tics) ~ 1,
      r7tics < 12 ~ 1,
      is.na(r8tics) ~ 2,
      r8tics < 12 ~ 2,
      is.na(r9tics) ~ 3,
      r9tics < 12 ~ 3,
      is.na(r10tics) ~ 4,
      r10tics < 12 ~ 4,
      is.na(r11tics) ~ 5,
      r11tics < 12 ~ 5,
      is.na(r12tics) ~ 6,
      r12tics < 12 ~ 6,
      is.na(r13tics) ~ 7,
      r13tics < 12 ~ 7,
      is.na(r14tics) ~ 8,
      r14tics < 12 ~ 8,
      is.na(r15tics) ~ 9,
      r15tics < 12 ~ 9,
      TRUE ~ 9  # Censored at the last time point if no event occurred
),
    event = case_when(
      is.na(r7tics) ~ 0,
      r10tics < 12 ~ 1,
      is.na(r8tics) ~ 0,
      r10tics < 12 ~ 1,
      is.na(r9tics) ~ 0,
      r10tics < 12 ~ 1,
      is.na(r10tics) ~ 0,
      r10tics < 12 ~ 1,
      is.na(r11tics) ~ 0,
      r11tics < 12 ~ 1,
      is.na(r12tics) ~ 0,
      r12tics < 12 ~ 1,
      is.na(r13tics) ~ 0,
      r13tics < 12 ~ 1,
      is.na(r14tics) ~ 0,
      r14tics < 12 ~ 1,
      is.na(r15tics) ~ 0,
      r15tics < 12 ~ 1,
      TRUE ~ 0  # Censored at the last time point if no event occurred
    )
  )
# Verify the updated cross-table
table(rand_hrs_jags$event_time, rand_hrs_jags$event, useNA = "always")

#survival and censoring times (all censored are right-censored)
#cens <- rand_hrs_jags$event_time
#rand_hrs_jags$event_time[rand_hrs_jags$event==0] <- NA  #censored
#is.censored <- as.numeric(is.na(rand_hrs_jags$event_time))

```


```{r}
# Define demographic columns of interest to provide summary statistics
demo_columns <- c("r6cesd", 
                  "r6chron_disease", 
                  "r6iadltot_h", 
                  "r6adltot6",
                  "r6agey_e")
demo_cat_columns <- c("raeducl", 
                      "raracem", 
                      "ragender",
                      "h6rural")


# Loop through numeric columns
for (i in demo_columns) {
  print(i)
  print(mean(rand_hrs_email[[i]], na.rm = TRUE))
  print(sd(rand_hrs_email[[i]], na.rm = TRUE))
}

# Loop through categorical columns
for (i in demo_cat_columns) {
  print(i)
  print(table(rand_hrs_email[[i]], useNA = "always"))
}

```

```{r}
#----------------------------
#Joint latent growth-survival model
# 
# rand_hrs_jags <- rand_hrs_data
# 
# #rand_hrs_jags <- rand_hrs_jags.copy
# 
# # preparation
# rand_hrs_jags <- rand_hrs_jags %>%
#   mutate(
#     event_time = case_when(
#       is.na(r10tics) ~ 1,
#       r10tics < 12 ~ 1,
#       is.na(r11tics) ~ 2,
#       r11tics < 12 ~ 2,
#       is.na(r12tics) ~ 3,
#       r12tics < 12 ~ 3,
#       is.na(r13tics) ~ 4,
#       r13tics < 12 ~ 4,
#       is.na(r14tics) ~ 5,
#       r14tics < 12 ~ 5,
#       is.na(r15tics) ~ 6,
#       r15tics < 12 ~ 6,
#       TRUE ~ 6  # Censored at the last time point if no event occurred
#     ),
#     event = case_when(
#       is.na(r10tics) ~ 0,
#       r10tics < 12 ~ 1,
#       is.na(r11tics) ~ 0,
#       r11tics < 12 ~ 1,
#       is.na(r12tics) ~ 0,
#       r12tics < 12 ~ 1,
#       is.na(r13tics) ~ 0,
#       r13tics < 12 ~ 1,
#       is.na(r14tics) ~ 0,
#       r14tics < 12 ~ 1,
#       is.na(r15tics) ~ 0,
#       r15tics < 12 ~ 1,
#       TRUE ~ 0  # Censored at the last time point if no event occurred
#     )
#   )
# 
# # Verify the updated cross-table
# table(rand_hrs_jags$event_time, rand_hrs_jags$event, useNA = "always")
# 
# #survival and censoring times (all censored data are right-censored)
# cens <- rand_hrs_jags$event_time
# rand_hrs_jags$event_time[rand_hrs_jags$event==0] <- NA  #censored
# is.censored <- as.numeric(is.na(rand_hrs_jags$event_time))

```



~~

```{r}
#impute NA values with the median

rand_hrs_jags$r7email[is.na(rand_hrs_jags$r7email)] <- median(rand_hrs_jags$r7email)
rand_hrs_jags$r8email[is.na(rand_hrs_jags$r8email)] <- median(rand_hrs_jags$r8email)
rand_hrs_jags$r9email[is.na(rand_hrs_jags$r9email)] <- median(rand_hrs_jags$r9email)
rand_hrs_jags$r10email[is.na(rand_hrs_jags$r10email)] <- median(rand_hrs_jags$r10email)
rand_hrs_jags$r11email[is.na(rand_hrs_jags$r11email)] <- median(rand_hrs_jags$r11email)
rand_hrs_jags$r12email[is.na(rand_hrs_jags$r12email)] <- median(rand_hrs_jags$r12email)
rand_hrs_jags$r13email[is.na(rand_hrs_jags$r13email)] <- median(rand_hrs_jags$r13email)
rand_hrs_jags$r14email[is.na(rand_hrs_jags$r14email)] <- median(rand_hrs_jags$r14email)
rand_hrs_jags$r15email[is.na(rand_hrs_jags$r15email)] <- median(rand_hrs_jags$r15email)

rand_hrs_jags$r6agey_e[is.na(rand_hrs_jags$r6agey_e)] <- median(rand_hrs_jags$r6agey_e, na.rm = T)
rand_hrs_jags$r7agey_e[is.na(rand_hrs_jags$r7agey_e)] <- median(rand_hrs_jags$r7agey_e, na.rm = T)
rand_hrs_jags$r8agey_e[is.na(rand_hrs_jags$r8agey_e)] <- median(rand_hrs_jags$r8agey_e, na.rm = T)

rand_hrs_jags$r9agey_e[is.na(rand_hrs_jags$r9agey_e)] <- median(rand_hrs_jags$r9agey_e, na.rm = T)
rand_hrs_jags$r10agey_e[is.na(rand_hrs_jags$r10agey_e)] <- median(rand_hrs_jags$r10agey_e, na.rm = T)
rand_hrs_jags$r11agey_e[is.na(rand_hrs_jags$r11agey_e)] <- median(rand_hrs_jags$r11agey_e, na.rm = T)
rand_hrs_jags$r12agey_e[is.na(rand_hrs_jags$r12agey_e)] <- median(rand_hrs_jags$r12agey_e, na.rm = T)
rand_hrs_jags$r13agey_e[is.na(rand_hrs_jags$r13agey_e)] <- median(rand_hrs_jags$r13agey_e, na.rm = T)
rand_hrs_jags$r14agey_e[is.na(rand_hrs_jags$r14agey_e)] <- median(rand_hrs_jags$r14agey_e, na.rm = T)
rand_hrs_jags$r15agey_e[is.na(rand_hrs_jags$r15agey_e)] <- median(rand_hrs_jags$r15agey_e, na.rm = T)


rand_hrs_jags$r6cesd[is.na(rand_hrs_jags$r6cesd)] <- median(rand_hrs_jags$r6cesd, na.rm = T)
rand_hrs_jags$r7cesd[is.na(rand_hrs_jags$r7cesd)] <- median(rand_hrs_jags$r7cesd, na.rm = T)
rand_hrs_jags$r8cesd[is.na(rand_hrs_jags$r8cesd)] <- median(rand_hrs_jags$r8cesd, na.rm = T)

rand_hrs_jags$r9cesd[is.na(rand_hrs_jags$r9cesd)] <- median(rand_hrs_jags$r9cesd, na.rm = T)
rand_hrs_jags$r10cesd[is.na(rand_hrs_jags$r10cesd)] <- median(rand_hrs_jags$r10cesd, na.rm = T)
rand_hrs_jags$r11cesd[is.na(rand_hrs_jags$r11cesd)] <- median(rand_hrs_jags$r11cesd, na.rm = T)
rand_hrs_jags$r12cesd[is.na(rand_hrs_jags$r12cesd)] <- median(rand_hrs_jags$r12cesd, na.rm = T)
rand_hrs_jags$r13cesd[is.na(rand_hrs_jags$r13cesd)] <- median(rand_hrs_jags$r13cesd, na.rm = T)
rand_hrs_jags$r14cesd[is.na(rand_hrs_jags$r14cesd)] <- median(rand_hrs_jags$r14cesd, na.rm = T)
rand_hrs_jags$r15cesd[is.na(rand_hrs_jags$r15cesd)] <- median(rand_hrs_jags$r15cesd, na.rm = T)

rand_hrs_jags$r6chron_disease[is.na(rand_hrs_jags$r6chron_disease)] <- median(rand_hrs_jags$r6chron_disease, na.rm = T)
rand_hrs_jags$r7chron_disease[is.na(rand_hrs_jags$r7chron_disease)] <- median(rand_hrs_jags$r7chron_disease, na.rm = T)
rand_hrs_jags$r8chron_disease[is.na(rand_hrs_jags$r8chron_disease)] <- median(rand_hrs_jags$r8chron_disease, na.rm = T)
rand_hrs_jags$r9chron_disease[is.na(rand_hrs_jags$r9chron_disease)] <- median(rand_hrs_jags$r9chron_disease, na.rm = T)

rand_hrs_jags$r10chron_disease[is.na(rand_hrs_jags$r10chron_disease)] <- median(rand_hrs_jags$r10chron_disease, na.rm = T)
rand_hrs_jags$r11chron_disease[is.na(rand_hrs_jags$r11chron_disease)] <- median(rand_hrs_jags$r11chron_disease, na.rm = T)
rand_hrs_jags$r12chron_disease[is.na(rand_hrs_jags$r12chron_disease)] <- median(rand_hrs_jags$r12chron_disease, na.rm = T)
rand_hrs_jags$r13chron_disease[is.na(rand_hrs_jags$r13chron_disease)] <- median(rand_hrs_jags$r13chron_disease, na.rm = T)
rand_hrs_jags$r14chron_disease[is.na(rand_hrs_jags$r14chron_disease)] <- median(rand_hrs_jags$r14chron_disease, na.rm = T)
rand_hrs_jags$r15chron_disease[is.na(rand_hrs_jags$r15chron_disease)] <- median(rand_hrs_jags$r15chron_disease, na.rm = T)


rand_hrs_jags$r6iadltot_h[is.na(rand_hrs_jags$r6iadltot_h)] <- median(rand_hrs_jags$r6iadltot_h, na.rm = T)
rand_hrs_jags$r7iadltot_h[is.na(rand_hrs_jags$r7iadltot_h)] <- median(rand_hrs_jags$r7iadltot_h, na.rm = T)
rand_hrs_jags$r8iadltot_h[is.na(rand_hrs_jags$r8iadltot_h)] <- median(rand_hrs_jags$r8iadltot_h, na.rm = T)
rand_hrs_jags$r9iadltot_h[is.na(rand_hrs_jags$r9iadltot_h)] <- median(rand_hrs_jags$r9iadltot_h, na.rm = T)


rand_hrs_jags$r10iadltot_h[is.na(rand_hrs_jags$r10iadltot_h)] <- median(rand_hrs_jags$r10iadltot_h, na.rm = T)
rand_hrs_jags$r11iadltot_h[is.na(rand_hrs_jags$r11iadltot_h)] <- median(rand_hrs_jags$r11iadltot_h, na.rm = T)
rand_hrs_jags$r12iadltot_h[is.na(rand_hrs_jags$r12iadltot_h)] <- median(rand_hrs_jags$r12iadltot_h, na.rm = T)
rand_hrs_jags$r13iadltot_h[is.na(rand_hrs_jags$r13iadltot_h)] <- median(rand_hrs_jags$r13iadltot_h, na.rm = T)
rand_hrs_jags$r14iadltot_h[is.na(rand_hrs_jags$r14iadltot_h)] <- median(rand_hrs_jags$r14iadltot_h, na.rm = T)
rand_hrs_jags$r15iadltot_h[is.na(rand_hrs_jags$r15iadltot_h)] <- median(rand_hrs_jags$r15iadltot_h, na.rm = T)



rand_hrs_jags$r6adltot6[is.na(rand_hrs_jags$r6adltot6)] <- median(rand_hrs_jags$r10adltot6, na.rm = T)
rand_hrs_jags$r7adltot6[is.na(rand_hrs_jags$r7adltot6)] <- median(rand_hrs_jags$r7adltot6, na.rm = T)
rand_hrs_jags$r8adltot6[is.na(rand_hrs_jags$r8adltot6)] <- median(rand_hrs_jags$r8adltot6, na.rm = T)
rand_hrs_jags$r9adltot6[is.na(rand_hrs_jags$r9adltot6)] <- median(rand_hrs_jags$r9adltot6, na.rm = T)

rand_hrs_jags$r10adltot6[is.na(rand_hrs_jags$r10adltot6)] <- median(rand_hrs_jags$r10adltot6, na.rm = T)
rand_hrs_jags$r11adltot6[is.na(rand_hrs_jags$r11adltot6)] <- median(rand_hrs_jags$r11adltot6, na.rm = T)
rand_hrs_jags$r12adltot6[is.na(rand_hrs_jags$r12adltot6)] <- median(rand_hrs_jags$r12adltot6, na.rm = T)
rand_hrs_jags$r13adltot6[is.na(rand_hrs_jags$r13adltot6)] <- median(rand_hrs_jags$r13adltot6, na.rm = T)
rand_hrs_jags$r14adltot6[is.na(rand_hrs_jags$r14adltot6)] <- median(rand_hrs_jags$r14adltot6, na.rm = T)
rand_hrs_jags$r15adltot6[is.na(rand_hrs_jags$r15adltot6)] <- median(rand_hrs_jags$r15adltot6, na.rm = T)

table(rand_hrs_jags$r15email, useNA = "always")

```


```{r}
#y <- as.numeric(unlist(rand_hrs_jags[, c("r6email", "r7email", "r8email", "r9email", "r10email", 
                        #                 "r11email", "r12email", "r13email", "r14email", "r15email")]))

df_long <- rand_hrs_jags %>%
  zap_labels() %>% 
  zap_formats() %>% 
  zap_label() %>% 
  dplyr::select(
    hhidpn,
    r6cesd:r15cesd,
    r6chron_disease:r15chron_disease,
    r6iadltot_h:r15iadltot_h,
    r6adltot6:r15adltot6,
    r6email:r15email
  ) %>%
 pivot_longer(
    cols = starts_with("r"),   
    names_to = c("wave", "variable"),  
    names_pattern = "r(\\d+)_?(.*)"    
 ) %>%
mutate(time = as.integer(wave) - 6) %>%
 pivot_wider(
    names_from = variable,   
    values_from = value      
  ) %>%
  arrange(hhidpn, wave) %>% 
  dplyr::select(!cesdm) %>% 
  dplyr::select(!adltot6m) %>% 
  dplyr::select(!adltot6a)



tt <- df_long$time

N <- nrow(df_long)
n <- length(unique(df_long$hhidpn))

ID <- as.integer(factor(df_long$hhidpn))

X1 <- as.matrix(df_long[, c("cesd", "chron_disease", "iadltot_h", "adltot6")]) 

cens_time <- rand_hrs_jags$event_time  
status <- rand_hrs_jags$event         


max_censor_time <- 6 

cens_time[status == 0] <- max_censor_time  



time <- cens_time  

#status <- as.numeric(is.na(cens_time)) 

y <- df_long$email 



X2 <- model.matrix(~ ragender + r6agey_e + raeducl2 + raeducl3 + raracem1_r, data = rand_hrs_jags)

data_save <- list(N = N, n = n, nX1 = ncol(X1), nX2 = ncol(X2), 
                         y = y, tt = tt, X1 = X1, ID = ID, 
                         time = time, status = status, X2 = X2)
save(data_save, file = "model_data.RData")
 
fit <- stan(file = "/home/danny/Documents/projects/aadl_hrs/JM.stan",
            data = list(N = N, n = n, nX1 = ncol(X1), nX2 = ncol(X2), 
                         y = y, tt = tt, X1 = X1, ID = ID, 
                         time = time, status = status, X2 = X2),
           warmup = 1000,                 
           iter   = 2000,
           chains = 3,
           seed   = 123,
           cores  = getOption("mc.cores",9)
          )

```

```{r}
launch_shinystan(fit)

```

```{r}
post_samples <- rstan::extract(fit)
```


```{r}
# Extract relevant posterior samples from the Stan model
alpha_samples <- post_samples$alpha
gamma_samples <- post_samples$gamma
bi_samples <- post_samples$bi
phi_samples <- post_samples$phi
sex <- rand_hrs_jags$ragender

# Number of individuals (n)
n <- 3862

# Grid of time points to evaluate survival curves
grid <- 1000
time <- seq(0.001, max(df_long$time), length.out = grid)

# Prepare an empty matrix to store the survival curves
surv <- matrix(NA, n, grid)

# Calculate the individual survival curves


# Compute survival probabilities
for (i in 1:n) {
  for (k in 1:grid) {
    # Compute lambda for patient i
    lambda <- exp(rowSums(gamma_samples * matrix(rep(X2[i,], each = nrow(gamma_samples)), 
                                                 nrow = nrow(gamma_samples), byrow = FALSE)))
    
    # Compute survival function at time[k]
    if (k <= length(time)) {
      survival_curve <- exp(-lambda * exp(alpha_samples[, 1] * bi_samples[, i, 1] + 
                                          alpha_samples[, 2] * bi_samples[, i, 2]) * 
                                          time[k]^phi_samples)
      surv[i, k] <- mean(survival_curve)
    } else {
      stop("Error: k exceeds length of time vector")
    }
  }
}



```
## Internet Use

```{r}
# Create a dataframe for plotting with ggplot
email_col <- as.character(as_factor(rand_hrs_jags$r6email))
email_col[email_col == "0.no"] <- "No Internet Use at Baseline"
email_col[email_col == "1.yes"] <- "Internet Use at Baseline"

# Convert the survival matrix to a long format for ggplot
df_email <- data.frame(time = rep(time, n),
                 survival = c(t(surv)),
                 patient = rep(1:n, each = grid),
                 email = rep(email_col, each = grid))


ggplot(data = df_email, aes(x = time, y = survival, group = patient, colour = email)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "top") +
  labs(title = "Individual Survival Curves", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("No Internet Use at Baseline" = "blue", 
                                 "Internet Use at Baseline" = "red"))
```

```{r}
#  Compute mean survival probability for each patient
mean_survival <- rowMeans(surv, na.rm = TRUE)

# Assign patients to quartiles based on mean survival probability
quartile_labels <- c("Q1 (Lowest 25%)", "Q2 (25-50%)", "Q3 (50-75%)", "Q4 (Highest 25%)")
quartile_groups <- cut(mean_survival, 
                       breaks = quantile(mean_survival, probs = seq(0, 1, 0.25), na.rm = TRUE),
                       include.lowest = TRUE, 
                       labels = quartile_labels)

# Create an empty dataframe for grouped survival data
df_grouped_email <- expand.grid(time = time, quartile = quartile_labels, email = c("No Internet Use at Baseline", "Internet Use at Baseline"))
df_grouped_email$survival <- NA
df_grouped_email$sd <- NA  # Placeholder for standard deviation

# Compute mean and standard deviation of survival for each group
for (q in quartile_labels) {
  for (s in c("No Internet Use at Baseline", "Internet Use at Baseline")) {
    idx <- which(email_col == s & quartile_groups == q)  
    if (length(idx) > 0) {
      df_grouped_email$survival[df_grouped_email$quartile == q & df_grouped_email$email == s] <- colMeans(surv[idx, ], na.rm = TRUE)
      df_grouped_email$sd[df_grouped_email$quartile == q & df_grouped_email$email == s] <- apply(surv[idx, ], 2, sd, na.rm = TRUE)  
    }
  }
}

# Add confidence bands
df_grouped_email <- df_grouped_email %>%
  mutate(lower = pmax(survival - sd, 0),  
         upper = pmin(survival + sd, 1))   

# Plot the quartile-based survival curves 
email_plot <- ggplot(data = df_grouped_email, aes(x = time, y = survival, colour = email, linetype = quartile)) +
  geom_line(size = 1) +  
  #geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.05) +  # Shaded area for standard deviation
  theme_bw() +
  theme(legend.position = "right") +
  labs(title = "Survival Curves by Quartiles and Baseline Internet Use", 
       x = "Time", 
       y = "Survival Probability",
       colour = "Baseline Internet Use",
       linetype = "Quartile") +
  scale_colour_manual(values = c("No Internet Use at Baseline" = "#d95f02", 
                                 "Internet Use at Baseline" = "#1b9e77"),
                      labels = c("No Internet Use\n at Baseline", 
                                 "Internet Use\n at Baseline")) +
  theme(legend.text = element_text(size = 12)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_fill_manual(values = c("No Internet Use at Baseline" = "#d95f02", 
                               "Internet Use at Baseline" = "#1b9e77")) +  # Shading matches line color
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash"))  # Different line types for quartiles

ggsave(filename = "email plot no shading.png", 
       plot = email_plot,
       dpi = 300,
       width = 12,
       height = 8)
```
## Education

```{r}
# Create a dataframe for plotting with ggplot
edu_col <- as.character(as_factor(rand_hrs_jags$raeducl))
edu_col[edu_col == "1"] <- "Less than Upper Secondary"
edu_col[edu_col == "2"] <- "Upper Secondary and Vocational"
edu_col[edu_col == "3"] <- "Tertiary"


# Convert the survival matrix to a long format for ggplot
df_edu <- data.frame(time = rep(time, n),
                 survival = c(t(surv)),
                 patient = rep(1:n, each = grid),
                 edu = rep(edu_col, each = grid),
                 email = rep(email_col, each=grid))


ggplot(data = df_edu, aes(x = time, y = survival, group = patient, colour = edu)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "top") +
  labs(title = "Individual Survival Curves", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("Less than Upper Secondary" = "#1b9e77", 
                                 "Upper Secondary and Vocational" = "#d95f02",
                                 "Tertiary" = "#7570b3"))


```

```{r}
#  Compute mean survival probability for each patient
mean_survival <- rowMeans(surv, na.rm = TRUE)

# Assign patients to quartiles based on mean survival probability
quartile_labels <- c("Q1 (Lowest 25%)", "Q2 (25-50%)", "Q3 (50-75%)", "Q4 (Highest 25%)")
quartile_groups <- cut(mean_survival, 
                       breaks = quantile(mean_survival, probs = seq(0, 1, 0.25), na.rm = TRUE),
                       include.lowest = TRUE, 
                       labels = quartile_labels)

# Create an empty dataframe for grouped survival data
df_grouped_edu <- expand.grid(time = time, 
                              quartile = quartile_labels, 
                              edu = c("Less than Upper Secondary", 
                                 "Upper Secondary and Vocational",
                                 "Tertiary"),
                              email = c("No Internet Use at Baseline", "Internet Use at Baseline"))
df_grouped_edu$survival <- NA
df_grouped_edu$sd <- NA  # Placeholder for standard deviation
surv_matrix <- matrix(surv, ncol = length(time))

# Compute mean and standard deviation of survival for each group
for (q in quartile_labels) {
  for (e in c("Less than Upper Secondary", "Upper Secondary and Vocational", "Tertiary")) {
    for (s in c("No Internet Use at Baseline", "Internet Use at Baseline")) {
      idx <- which(edu_col == e & quartile_groups == q & email_col == s)
      if (length(idx) > 0) {
        df_grouped_edu$survival[df_grouped_edu$quartile == q & df_grouped_edu$edu == e & df_grouped_edu$email == s] <- colMeans(surv_matrix[idx, ], na.rm = TRUE)
        df_grouped_edu$sd[df_grouped_edu$quartile == q & df_grouped_edu$edu == e & df_grouped_edu$email == s] <- apply(surv_matrix[idx, ], 2, sd, na.rm = TRUE)
      }
    }
  }
}

# Add confidence bands
df_grouped_edu <- df_grouped_edu %>%
  mutate(lower = pmax(survival - sd, 0),  
         upper = pmin(survival + sd, 1))  


#: Plot the quartile-based survival curves with shading
edu_plot <- ggplot(data = df_grouped_edu, aes(x = time, y = survival, colour = edu, linetype = quartile)) +
  geom_line(size = 1) +  
  #geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.0005) +  # Shaded area for standard deviation
  theme_bw() +
  theme(legend.position = "top") +
  labs(title = "Survival Curves by Quartiles and Education Level", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("Less than Upper Secondary" = "#1b9e77", 
                                 "Upper Secondary and Vocational" = "#d95f02",
                                 "Tertiary" = "#7570b3")) +
#  scale_fill_manual(values = c("Less than Upper Secondary" = "#1b9e77", 
 #                                "Upper Secondary and Vocational" = "#d95f02",
  #                               "Tertiary" = "#7570b3")) +  # Shading matches line color
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash")) +
  facet_wrap(~as.factor(df_grouped_email$email))

print(edu_plot)

```

```{r}
email_col <- as.character(as_factor(rand_hrs_jags$r6email))
email_col[email_col == "0.no"] <- "No Internet Use at Baseline"
email_col[email_col == "1.yes"] <- "Internet Use at Baseline"

edu_col <- as.character(as_factor(rand_hrs_jags$raeducl))
edu_col[edu_col == "1"] <- "Less than Upper Secondary"
edu_col[edu_col == "2"] <- "Upper Secondary and Vocational"
edu_col[edu_col == "3"] <- "Tertiary"

# Ensure these vectors have the same length as n (number of individuals)
if (length(email_col) != n | length(edu_col) != n) {
  stop("Error: Mismatch in number of individuals between surv and email/edu variables.")
}

# Convert the survival matrix to long format while keeping email and education aligned
df <- data.frame(
  time = rep(time, n),                
  survival = c(t(surv)),              
  patient = rep(1:n, each = grid),    
  email = rep(email_col, each = grid), 
  edu = rep(edu_col, each = grid)     
)

mean_survival <- rowMeans(surv, na.rm = TRUE)

# Assign patients to quartiles based on mean survival probability
quartile_labels <- c("Q1 (Lowest 25%)", "Q2 (25-50%)", "Q3 (50-75%)", "Q4 (Highest 25%)")
quartile_groups <- cut(mean_survival, 
                       breaks = quantile(mean_survival, probs = seq(0, 1, 0.25), na.rm = TRUE),
                       include.lowest = TRUE, 
                       labels = quartile_labels)

# Create an empty dataframe for grouped survival data
df_grouped_edu_email <- expand.grid(time = time, 
                                    quartile = quartile_labels, 
                                    edu = c("Less than Upper Secondary", "Upper Secondary and Vocational", "Tertiary"),
                                    email = c("No Internet Use at Baseline", "Internet Use at Baseline"))
df_grouped_edu_email$survival <- NA
df_grouped_edu_email$sd <- NA  

for (q in quartile_labels) {
  for (e in c("Less than Upper Secondary", "Upper Secondary and Vocational", "Tertiary")) {
    for (s in c("No Internet Use at Baseline", "Internet Use at Baseline")) {
      
      # Find indices of patients matching quartile, education, and email group
      idx <- which(email_col == s & edu_col == e & quartile_groups == q)
      
      if (length(idx) > 0) {
       
        group_surv <- surv[idx, , drop = FALSE]
        
        if (nrow(group_surv) == 1) {
          df_grouped_edu_email$survival[
            df_grouped_edu_email$quartile == q & 
            df_grouped_edu_email$edu == e & 
            df_grouped_edu_email$email == s] <- as.numeric(group_surv)
          df_grouped_edu_email$sd[
            df_grouped_edu_email$quartile == q & 
            df_grouped_edu_email$edu == e & 
            df_grouped_edu_email$email == s] <- NA
        } else {
          df_grouped_edu_email$survival[
            df_grouped_edu_email$quartile == q & 
            df_grouped_edu_email$edu == e & 
            df_grouped_edu_email$email == s] <- colMeans(group_surv, na.rm = TRUE)
          df_grouped_edu_email$sd[
            df_grouped_edu_email$quartile == q & 
            df_grouped_edu_email$edu == e & 
            df_grouped_edu_email$email == s] <- apply(group_surv, 2, sd, na.rm = TRUE)
        }
      }
    }
  }
}

#  Add confidence bands
df_grouped_edu_email <- df_grouped_edu_email %>%
  mutate(lower = pmax(survival - sd, 0),  
         upper = pmin(survival + sd, 1))  

# Plot the quartile-based survival curves with faceting by email use
edu_plot <- ggplot(data = df_grouped_edu_email, aes(x = time, y = survival, colour = edu, linetype = quartile)) +
  geom_line(size = 1) +  
  theme_bw() +
  theme(legend.position = "right") +
  labs(title = "Survival Curves by Quartiles, Education Level, and Internet Use", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("Less than Upper Secondary" = "#1b9e77", 
                                 "Upper Secondary and Vocational" = "#d95f02",
                                 "Tertiary" = "#7570b3"),
                      labels = c("Less than\n Upper Secondary", 
                                 "Upper Secondary\n and Vocational",
                                 "Tertiary")) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash")) +
  facet_wrap(~email)

ggsave(filename = "edu plot no shading facet.png", 
       plot = edu_plot,
       dpi = 300,
       width = 12,
       height = 8)
```

```{r}
df_participants <- data.frame(
  email = email_col,
  edu = edu_col,
  quartile = quartile_groups
)

table(df_participants$email, df_participants$edu, df_participants$quartile)
```

```{r}
overall_means <- df_grouped_edu_email %>%
  group_by(quartile, edu, email) %>%
  summarise("Mean Survival Probability" = mean(survival, na.rm = TRUE),
            "Standard Deviation" = sd(survival, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(across(where(is.numeric), ~ round(.x, 2))) %>%
    rename_with(~ str_to_title(.), .cols = c("quartile", "edu", "email"))

table_html_edu <- overall_means %>%
  flextable() %>%
  autofit()

# Save as HTML file
save_as_html(table_html_edu, path = "survival_table_edu.html")
```



## Race

```{r}
# Create a dataframe for plotting with ggplot
race_col <- as.character(as_factor(rand_hrs_jags$raracem))
race_col[race_col == "1"] <- "White/Caucasian"
race_col[race_col %in% c("2", "3")] <- "Non-White"

# Convert the survival matrix to a long format for ggplot
df_race <- data.frame(time = rep(time, n),
                 survival = c(t(surv)),
                 patient = rep(1:n, each = grid),
                 race = rep(race_col, each = grid))


ggplot(data = df_race, aes(x = time, y = survival, group = patient, colour = race)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "top") +
  labs(title = "Individual Survival Curves", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("White/Caucasian" = "#1b9e77", 
                                 "Non-White" = "#d95f02"))
```

```{r}
#Compute mean survival probability for each patient
mean_survival <- rowMeans(surv, na.rm = TRUE)

email_col <- as.character(as_factor(rand_hrs_jags$r6email))
email_col[email_col == "0.no"] <- "No Internet Use at Baseline"
email_col[email_col == "1.yes"] <- "Internet Use at Baseline"



df <- data.frame(
  time = rep(time, n),                
  survival = c(t(surv)),         
  patient = rep(1:n, each = grid),    
  email = rep(email_col, each = grid), 
  edu = rep(edu_col, each = grid)   
)

mean_survival <- rowMeans(surv, na.rm = TRUE)

# Assign patients to quartiles based on mean survival probability
quartile_labels <- c("Q1 (Lowest 25%)", "Q2 (25-50%)", "Q3 (50-75%)", "Q4 (Highest 25%)")
quartile_groups <- cut(mean_survival, 
                       breaks = quantile(mean_survival, probs = seq(0, 1, 0.25), na.rm = TRUE),
                       include.lowest = TRUE, 
                       labels = quartile_labels)

# Create an empty dataframe for grouped survival data
df_grouped_race <- expand.grid(time = time, 
                                    quartile = quartile_labels, 
                                    race = c("White/Caucasian", "Non-White"),
                                    email = c("No Internet Use at Baseline", "Internet Use at Baseline"))
df_grouped_race$survival <- NA
df_grouped_race$sd <- NA  

for (q in quartile_labels) {
  for (e in c("White/Caucasian", "Non-White")) {
    for (s in c("No Internet Use at Baseline", "Internet Use at Baseline")) {
      
      # Find indices of patients matching quartile, race, and email group
      idx <- which(email_col == s & race_col == e & quartile_groups == q)
      
      if (length(idx) > 0) {
        group_surv <- surv[idx, , drop = FALSE]
        
        if (nrow(group_surv) == 1) {
          df_grouped_race$survival[
            df_grouped_race$quartile == q & 
            df_grouped_race$race == e & 
            df_grouped_race$email == s] <- as.numeric(group_surv)
          df_grouped_race$sd[
            df_grouped_race$quartile == q & 
            df_grouped_race$race == e & 
            df_grouped_race$email == s] <- NA
        } else {
          df_grouped_race$survival[
            df_grouped_race$quartile == q & 
            df_grouped_race$race == e & 
            df_grouped_race$email == s] <- colMeans(group_surv, na.rm = TRUE)
          df_grouped_race$sd[
            df_grouped_race$quartile == q & 
            df_grouped_race$race == e & 
            df_grouped_race$email == s] <- apply(group_surv, 2, sd, na.rm = TRUE)
        }
      }
    }
  }
}


# Add confidence bands
df_grouped_race <- df_grouped_race %>%
  mutate(lower = pmax(survival - sd, 0),  
         upper = pmin(survival + sd, 1))  

# Plot the quartile-based survival curves with shading
race_plot <- ggplot(data = df_grouped_race, aes(x = time, y = survival, colour = race, linetype = quartile)) +
  geom_line(size = 1) +  
  #geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.0005) +  # Shaded area for standard deviation
  theme_bw() +
  theme(legend.position = "right") +
  labs(title = "Survival Curves by Quartiles and Race", 
       x = "Time", 
       y = "Survival Probability") +
  scale_colour_manual(values = c("White/Caucasian" = "#1b9e77", 
                                 "Non-White" = "#d95f02")) +
#  scale_fill_manual(values = c("Less than Upper Secondary" = "#1b9e77"     , 
 #                                "Upper Secondary and Vocational" = "#d95f02",
  #                               "Tertiary" = "#7570b3")) +  # Shading matches line color
  scale_linetype_manual(values = c("solid", "dashed", "dotted", "dotdash")) +
  facet_wrap(~email)

ggsave(filename = "race plot no shading facet.png", 
       plot = race_plot,
       dpi = 300,
       width = 12,
       height = 8)
```

```{r}
overall_means <- df_grouped_race %>%
  group_by(quartile, race, email) %>%
  summarise("Mean Survival Probability" = mean(survival, na.rm = TRUE),
            "Standard Deviation" = sd(survival, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(across(where(is.numeric), ~ round(.x, 2))) %>%
    rename_with(~ str_to_title(.), .cols = c("quartile", "race", "email"))

table_html_race <- overall_means %>%
  flextable() %>%
  autofit()

# Save as HTML file
save_as_html(table_html_race, path = "survival_table_race.html")
```



# No Covariate Model

```{r}

tt <- df_long$time

N <- nrow(df_long)
n <- length(unique(df_long$hhidpn))

ID <- as.integer(factor(df_long$hhidpn))

cens_time <- rand_hrs_jags$event_time  
status <- rand_hrs_jags$event         


max_censor_time <- 6 

cens_time[status == 0] <- max_censor_time  



time <- cens_time  

#status <- as.numeric(is.na(cens_time)) 

y <- df_long$email 



data_save <- list(N = N, n = n,
                         y = y, tt = tt, ID = ID, 
                         time = time, status = status )
save(data_save, file = "model_data_no_cov.RData")
 
fit_no_cov <- stan(file = "/path/to/your/data/JM-no-cov.stan",
            data = list(N = N, n = n, 
                         y = y, tt = tt, ID = ID, 
                         time = time, status = status),
           warmup = 1000,                 
           iter   = 5000,
           chains = 3,
           seed   = 123,
           cores  = getOption("mc.cores",9)
          )

```

```{r}
launch_shinystan(fit_no_cov)

```

```